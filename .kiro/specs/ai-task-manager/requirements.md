# 要件定義書

## 概要

このシステムは、Googleカレンダーを検索してタスクを抽出し、指定されたNotionデータベースに自動登録するAI駆動のタスク管理システムです。Gemini API、Google Apps Script（GAS）を組み合わせて、重複防止機能と日程管理機能を備えた統合システムを実現します。

## 要件

### 要件1: 多様な入力方法によるタスク整理

**ユーザーストーリー:** ユーザーとして、Web App UIで複数の入力方法（Gmail、カレンダー、音声入力）を選択してタスク整理を依頼したい。これにより、状況に応じて最適な方法でTodoアイテムを作成できる。

#### 受入基準

1. Web App UIでデータソース選択時、ユーザーは「Gmailから」「カレンダーから」「音声入力から」のオプションを選択できる
2. 「カレンダーから」を選択した時、システムは設定された期間のカレンダーイベントを分析してタスクを抽出する
3. 「Gmailから」を選択した時、システムは未読メールや指定期間のメールからタスクを抽出する
4. 「音声入力から」を選択した時、システムは音声認識でテキスト化し、そこからタスクを抽出する
5. いずれの方法でも、抽出されたタスクは同じNotionデータベースのTodoとして保存される

### 要件2: Gemini APIによるインテリジェントなタスク分析

**ユーザーストーリー:** ユーザーとして、Gemini APIを使用してカレンダーデータを高度に分析してもらいたい。これにより、適切なコンテキスト理解と優先度判定を持つタスクが抽出される。

#### 受入基準

1. 手動実行時にGemini APIがカレンダーデータにアクセスする時、システムは高度な自然言語理解でイベント内容を分析する
2. Gemini APIがタスクを抽出する時、システムは会議の目的、参加者、場所などのコンテキストを考慮して関連タスクを生成する
3. Gemini APIが優先度を判定する時、システムは締切の緊急性、重要度、依存関係を総合的に評価する
4. Gemini APIが重複チェックを行う時、システムは既存Notionタスクとの意味的類似性を判断する
5. 自動実行時はGAS単体で基本的な抽出を行い、複雑な判断が必要な場合はGemini APIへのフォールバック機能を提供する

### 要件3: タスクの重複防止

**ユーザーストーリー:** ユーザーとして、システムに重複タスクの作成を避けてもらいたい。これにより、Todoリストがクリーンで整理された状態を保てる。

#### 受入基準

1. 新しいタスクを抽出する時、システムは既存のNotionデータベースエントリと比較する
2. 重複の可能性があるタスクが見つかった時、システムは重複タスクの作成をスキップする
3. 重複をチェックする時、システムは完全一致のテキスト比較を超えたインテリジェントなマッチングを使用する
4. 類似のタスクが存在する時、システムは重複を作成するのではなく既存のタスクを更新する

### 要件4: GAS統合によるNotionデータベース管理

**ユーザーストーリー:** ユーザーとして、Google Apps Script内でNotionインテグレーションを完全に管理したい。これにより、セキュアで一元化されたタスク管理システムを持てる。

#### 受入基準

1. GAS内でNotionインテグレーショントークンを管理する時、システムはPropertiesServiceを使用してセキュアに保存する
2. GAS内でNotionデータベースIDを設定する時、システムは設定可能なプロパティとして管理する
3. タスクをNotionに作成する時、システムは直接Notion APIを呼び出してページを作成する
4. 手動実行（Claude経由）の場合、システムはGAS Web Appエンドポイントを提供してタスクデータを受信する
5. 自動実行の場合、システムはGAS内で完結してカレンダー分析からNotion登録まで実行する

### 要件5: 日程プロパティの適切な管理

**ユーザーストーリー:** ユーザーとして、タスクの日程情報を適切に管理してもらいたい。日程のあるタスクには期日を設定し、日程のないタスクには期日を設定しない。

#### 受入基準

1. カレンダーイベントから抽出されたタスクに明確な日程がある時、システムはNotionの日程プロパティに期日を設定する
2. カレンダーイベントから抽出されたタスクに明確な日程がない時、システムは日程プロパティを空のままにする
3. 準備タスクを生成する時、システムは元のイベント日程に基づいて適切な準備期日を計算する
4. 期日を設定する時、システムは日本のタイムゾーン（JST）を考慮する
5. 日程プロパティを更新する時、システムはNotionデータベースの日付フィールド形式に準拠する

### 要件6: エラーハンドリングとユーザーフィードバック

**ユーザーストーリー:** ユーザーとして、システムにエラーを適切に処理してもらいたい。何が問題だったかを理解し、適切な対処ができる。

#### 受入基準

1. カレンダーアクセスが失敗した時、システムは認証や権限の問題を明確に報告する
2. タスク抽出が失敗した時、システムは他のアイテムの処理を続行し、部分的な結果を報告する
3. GAS API呼び出しが失敗した時、システムはGASからの具体的なエラーメッセージを表示する
4. Notion API呼び出しが失敗した時、GASはエラーコードを含む構造化されたエラー情報を返す
5. いずれかのコンポーネントが失敗した時、システムは解決のための実行可能なガイダンスを提供する

### 要件7: 自動実行とAI判断の統合システム

**ユーザーストーリー:** ユーザーとして、GASで定期的に自動実行され、必要に応じてGemini APIで高度な判断を行うシステムを持ちたい。

#### 受入基準

1. GASが設定された周期で自動実行する時、システムはカレンダーイベントを取得してタスク候補を抽出する
2. 自動実行でタスクの必要性判断が困難な場合、システムはGemini APIに判断を委託する
3. Gemini APIがタスクの必要性を判断する時、システムは既存Notionタスクとの重複チェックと優先度評価を行う
4. 自動実行が完了した時、システムは実行結果サマリー（処理件数、作成件数、スキップ件数）をNotionデータベースに登録する
5. 手動で「整理してtodoに入れて」と依頼された時、システムは同じ自動実行プロセスを即座に実行する

### 要件8: 統合Web Appユーザーインターフェース

**ユーザーストーリー:** ユーザーとして、GAS Web Appで設定管理とタスク作成の両方を行える統合UIを持ちたい。これにより、一つのインターフェースで全ての操作を完結できる。

#### 受入基準

1. Web Appメイン画面で入力方法選択時、ユーザーは「Gmailから」「カレンダーから」「音声入力から」のボタンを選択できる
2. 音声入力選択時、システはブラウザのWeb Speech APIを使用してリアルタイム音声認識を提供する
3. 設定画面では、ユーザーは自動実行周期、データ取得期間、API認証情報を直感的なフォームで管理できる
4. 実行結果画面では、システムは処理されたアイテム数、作成されたタスク数、エラー情報をリアルタイムで表示する
5. 全ての画面で、システムはレスポンシブデザインでモバイルデバイスからも使いやすいUIを提供する

### 要件9: セキュアな認証情報管理

**ユーザーストーリー:** システム管理者として、APIキーと機密データが保護されるように、セキュアな認証情報管理を求める。

#### 受入基準

1. Notion API認証情報を保存する時、GASは安全な保存のためにPropertiesServiceを使用する
2. カレンダーにアクセスする時、システムは適切なOAuth2認証フローを使用する
3. API呼び出しを行う時、すべての認証情報は安全に送信される
4. エラーが発生した時、機密情報はエラーメッセージに露出されない
5. システムを設定する時、ユーザーは安全なセットアップ手順を案内される