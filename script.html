<script>
  let currentMethod = null;
  let recognition = null;
  let isRecording = false;
  
  /**
   * ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
   */
  function runCalendarCheck() {
    console.log('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒã‚§ãƒƒã‚¯é–‹å§‹');
    
    // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
    const button = document.getElementById('calendar-check-btn');
    button.disabled = true;
    button.innerHTML = 'ğŸ”„ ãƒã‚§ãƒƒã‚¯ä¸­...';
    
    // å‡¦ç†é–‹å§‹
    startCalendarProcessing();
  }
  
  /**
   * å…¥åŠ›æ–¹æ³•é¸æŠï¼ˆGmail/éŸ³å£°ç”¨ï¼‰
   */
  function selectMethod(method) {
    currentMethod = method;
    
    // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
    document.querySelectorAll('.method-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    document.getElementById(`${method}-btn`).classList.add('active');
    
    // éŸ³å£°å…¥åŠ›ã®å ´åˆã¯éŸ³å£°å…¥åŠ›UIã‚’è¡¨ç¤º
    if (method === 'voice') {
      document.getElementById('voice-input').style.display = 'block';
      initVoiceRecognition();
    } else {
      document.getElementById('voice-input').style.display = 'none';
      // å‡¦ç†é–‹å§‹
      startProcessing(method);
    }
  }
  
  /**
   * éŸ³å£°èªè­˜åˆæœŸåŒ–
   */
  function initVoiceRecognition() {
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      
      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.lang = 'ja-JP';
      
      recognition.onstart = function() {
        console.log('éŸ³å£°èªè­˜é–‹å§‹');
        document.getElementById('start-recording').style.display = 'none';
        document.getElementById('stop-recording').style.display = 'inline-block';
        document.getElementById('start-recording').classList.add('recording');
      };
      
      recognition.onresult = function(event) {
        let transcript = '';
        for (let i = 0; i < event.results.length; i++) {
          transcript += event.results[i][0].transcript;
        }
        document.getElementById('transcription').textContent = transcript;
        
        if (transcript.trim().length > 0) {
          document.getElementById('process-voice').style.display = 'inline-block';
        }
      };
      
      recognition.onerror = function(event) {
        console.error('éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼:', event.error);
        alert('éŸ³å£°èªè­˜ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + event.error);
        stopRecording();
      };
      
      recognition.onend = function() {
        console.log('éŸ³å£°èªè­˜çµ‚äº†');
        stopRecording();
      };
    } else {
      alert('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“');
    }
  }
  
  /**
   * éŒ²éŸ³é–‹å§‹
   */
  function startRecording() {
    if (recognition) {
      recognition.start();
      isRecording = true;
    }
  }
  
  /**
   * éŒ²éŸ³åœæ­¢
   */
  function stopRecording() {
    if (recognition && isRecording) {
      recognition.stop();
      isRecording = false;
    }
    
    document.getElementById('start-recording').style.display = 'inline-block';
    document.getElementById('stop-recording').style.display = 'none';
    document.getElementById('start-recording').classList.remove('recording');
  }
  
  /**
   * éŸ³å£°ã‚’ã‚¿ã‚¹ã‚¯ã«å¤‰æ›
   */
  function processVoiceInput() {
    const transcription = document.getElementById('transcription').textContent;
    if (transcription.trim().length === 0) {
      alert('éŸ³å£°ãŒèªè­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“');
      return;
    }
    
    startProcessing('voice', { transcription: transcription });
  }
  
  /**
   * ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å‡¦ç†é–‹å§‹ï¼ˆæ–°ã—ã„æ·±å¤œå®Ÿè¡Œã‚·ã‚¹ãƒ†ãƒ ä½¿ç”¨ï¼‰
   */
  function startCalendarProcessing() {
    // UIæ›´æ–°
    document.querySelector('.input-methods').style.display = 'none';
    document.getElementById('voice-input').style.display = 'none';
    document.getElementById('processing').style.display = 'block';
    document.getElementById('results').style.display = 'none';
    
    updateStatus('ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’ã‚¹ã‚­ãƒ£ãƒ³ä¸­...');
    
    // æ–°ã—ã„æ·±å¤œå®Ÿè¡Œã‚·ã‚¹ãƒ†ãƒ ã‚’å‘¼ã³å‡ºã—
    google.script.run
      .withSuccessHandler(onCalendarProcessingSuccess)
      .withFailureHandler(onProcessingError)
      .deepNightExecution();
  }
  
  /**
   * å‡¦ç†é–‹å§‹
   */
  function startProcessing(method, options = {}) {
    // UIæ›´æ–°
    document.querySelector('.input-methods').style.display = 'none';
    document.getElementById('voice-input').style.display = 'none';
    document.getElementById('processing').style.display = 'block';
    document.getElementById('results').style.display = 'none';
    
    updateStatus(`${getMethodName(method)}ã‹ã‚‰ã‚¿ã‚¹ã‚¯ã‚’æŠ½å‡ºä¸­...`);
    
    // GASé–¢æ•°å‘¼ã³å‡ºã— - WebAppFunctionsçµŒç”±
    let gasFunction;
    if (method === 'gmail') {
      gasFunction = 'transferGmailMessages';
    } else if (method === 'voice') {
      gasFunction = 'processVoiceInput';
      // éŸ³å£°ã®å ´åˆã¯å¼•æ•°ãŒç•°ãªã‚‹
      google.script.run
        .withSuccessHandler(onVoiceProcessingSuccess)
        .withFailureHandler(onProcessingError)
        [gasFunction](options.transcription);
      return;
    } else {
      gasFunction = 'runFullTaskExtraction';
    }
    
    google.script.run
      .withSuccessHandler(onProcessingSuccess)
      .withFailureHandler(onProcessingError)
      [gasFunction]();
  }
  
  /**
   * ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å‡¦ç†æˆåŠŸæ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
   */
  function onCalendarProcessingSuccess(result) {
    console.log('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å‡¦ç†æˆåŠŸ:', result);
    
    // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
    const button = document.getElementById('calendar-check-btn');
    button.disabled = false;
    button.innerHTML = 'ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ';
    
    document.getElementById('processing').style.display = 'none';
    document.getElementById('results').style.display = 'block';
    
    if (result.success) {
      displayCalendarResults(result);
    } else {
      displayError(result.error || 'ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    }
  }
  
  /**
   * å‡¦ç†æˆåŠŸæ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
   */
  function onProcessingSuccess(result) {
    console.log('å‡¦ç†æˆåŠŸ:', result);
    
    document.getElementById('processing').style.display = 'none';
    document.getElementById('results').style.display = 'block';
    
    if (result.success) {
      displayResults(result);
    } else {
      displayError(result.error || result.errors?.[0] || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    }
  }
  
  /**
   * éŸ³å£°å‡¦ç†æˆåŠŸæ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
   */
  function onVoiceProcessingSuccess(result) {
    console.log('éŸ³å£°å‡¦ç†æˆåŠŸ:', result);
    
    document.getElementById('processing').style.display = 'none';
    document.getElementById('results').style.display = 'block';
    
    if (result.success) {
      // éŸ³å£°å…¥åŠ›ç”¨ã®çµæœè¡¨ç¤º
      const voiceResult = {
        success: true,
        tasks: [result.task],
        transferred: 1,
        skipped: 0,
        processed: 1,
        message: 'ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆã—ã¾ã—ãŸ'
      };
      displayResults(voiceResult);
    } else {
      displayError(result.error || 'ã‚¿ã‚¹ã‚¯ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  }
  
  /**
   * å‡¦ç†ã‚¨ãƒ©ãƒ¼æ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
   */
  function onProcessingError(error) {
    console.error('å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
    
    document.getElementById('processing').style.display = 'none';
    document.getElementById('results').style.display = 'block';
    
    displayError(error.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
  }
  
  /**
   * çµæœè¡¨ç¤º
   */
  function displayResults(result) {
    const content = document.getElementById('result-content');
    
    const processed = result.processed || 0;
    const transferred = result.transferred || 0;
    const skipped = result.skipped || 0;
    
    if (result.tasks && result.tasks.length > 0) {
      content.innerHTML = `
        <div class="success">
          <h4>âœ… å‡¦ç†å®Œäº†</h4>
          <p>å‡¦ç†ä»¶æ•°: ${processed}ä»¶ã€ä½œæˆ: ${transferred}ä»¶ã€ã‚¹ã‚­ãƒƒãƒ—: ${skipped}ä»¶</p>
          <div class="task-list">
            ${result.tasks.map(task => `
              <div class="task-item">
                <div>
                  <strong>${task.title || 'ã‚¿ã‚¹ã‚¯'}</strong>
                  ${task.due_date ? `<div class="due-date">æœŸæ—¥: ${formatDate(task.due_date)}</div>` : ''}
                  ${task.context ? `<div class="task-context">${task.context}</div>` : ''}
                </div>
                <div>
                  <span class="priority priority-${task.priority || 'ä¸­'}">${task.priority || 'ä¸­'}</span>
                  ${task.created ? '<span style="color: #10b981; font-size: 12px;">âœ“ ä½œæˆæ¸ˆã¿</span>' : 
                    task.skipped ? '<span style="color: #f59e0b; font-size: 12px;">âš  é‡è¤‡ã‚¹ã‚­ãƒƒãƒ—</span>' : ''}
                </div>
              </div>
            `).join('')}
          </div>
        </div>
        <button onclick="resetUI()" class="reset-btn">æ–°ã—ã„å‡¦ç†ã‚’é–‹å§‹</button>
      `;
    } else if (transferred > 0 || skipped > 0) {
      content.innerHTML = `
        <div class="success">
          <h4>âœ… å‡¦ç†å®Œäº†</h4>
          <p>å‡¦ç†ä»¶æ•°: ${processed}ä»¶ã€ä½œæˆ: ${transferred}ä»¶ã€ã‚¹ã‚­ãƒƒãƒ—: ${skipped}ä»¶</p>
          <p>è©³ç´°ãªã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆã¯Notionã§ç¢ºèªã—ã¦ãã ã•ã„</p>
        </div>
        <button onclick="resetUI()" class="reset-btn">æ–°ã—ã„å‡¦ç†ã‚’é–‹å§‹</button>
      `;
    } else {
      content.innerHTML = `
        <div class="success">
          <h4>âœ… å‡¦ç†å®Œäº†</h4>
          <p>æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>
        </div>
        <button onclick="resetUI()" class="reset-btn">æ–°ã—ã„å‡¦ç†ã‚’é–‹å§‹</button>
      `;
    }
  }
  
  /**
   * ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼çµæœè¡¨ç¤º
   */
  function displayCalendarResults(result) {
    const content = document.getElementById('result-content');
    
    if (result.success) {
      const stats = result.stats || {};
      const verification = result.verification || {};
      
      let verificationInfo = '';
      if (verification.issues && verification.issues.length > 0) {
        verificationInfo = `
          <div class="warning">
            <h5>âš ï¸ æ¤œå‡ºã•ã‚ŒãŸå•é¡Œ</h5>
            <ul>
              ${verification.issues.map(issue => `<li>${issue}</li>`).join('')}
            </ul>
          </div>
        `;
      }
      
      content.innerHTML = `
        <div class="success">
          <h4>ğŸ‰ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒã‚§ãƒƒã‚¯å®Œäº†</h4>
          <div class="stats">
            <div class="stat-item">
              <span class="stat-label">ğŸ“Š ç·ã‚¤ãƒ™ãƒ³ãƒˆ:</span>
              <span class="stat-value">${stats.totalEvents || 0}ä»¶</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">ğŸ” æœªãƒãƒ¼ã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ:</span>
              <span class="stat-value">${stats.unmarkedEvents || 0}ä»¶</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">ğŸ“ å‡¦ç†æ¸ˆã¿ã‚¤ãƒ™ãƒ³ãƒˆ:</span>
              <span class="stat-value">${stats.processedEvents || 0}ä»¶</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">âœ… ä½œæˆã‚¿ã‚¹ã‚¯:</span>
              <span class="stat-value">${stats.createdTasks || 0}ä»¶</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">ğŸ¤– ãƒ­ãƒœãƒƒãƒˆãƒãƒ¼ã‚¯è¿½åŠ :</span>
              <span class="stat-value">${stats.markedEvents || 0}ä»¶</span>
            </div>
          </div>
          ${verificationInfo}
          <p class="execution-time">â±ï¸ å®Ÿè¡Œæ™‚é–“: ${Math.round((result.executionTime || 0) / 1000)}ç§’</p>
        </div>
        <button onclick="resetUI()" class="reset-btn">æ–°ã—ã„å‡¦ç†ã‚’é–‹å§‹</button>
      `;
    } else {
      displayError(result.error || 'ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒã‚§ãƒƒã‚¯ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    }
  }
  
  /**
   * ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
   */
  function displayError(error) {
    const content = document.getElementById('result-content');
    content.innerHTML = `
      <div class="error">
        <h4>âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h4>
        <p>${error}</p>
        <p><small>è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚Notion APIãƒˆãƒ¼ã‚¯ãƒ³ã¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹IDãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</small></p>
      </div>
      <button onclick="resetUI()" class="reset-btn">å†è©¦è¡Œ</button>
    `;
  }
  
  /**
   * UI ãƒªã‚»ãƒƒãƒˆ
   */
  function resetUI() {
    document.querySelector('.input-methods').style.display = 'block';
    document.getElementById('voice-input').style.display = 'none';
    document.getElementById('processing').style.display = 'none';
    document.getElementById('results').style.display = 'none';
    
    // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
    document.querySelectorAll('.method-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    
    // éŸ³å£°å…¥åŠ›ã®ãƒªã‚»ãƒƒãƒˆ
    document.getElementById('transcription').textContent = '';
    document.getElementById('process-voice').style.display = 'none';
    
    currentMethod = null;
  }
  
  /**
   * ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
   */
  function updateStatus(message) {
    document.getElementById('status-message').textContent = message;
  }
  
  /**
   * ãƒ¡ã‚½ãƒƒãƒ‰åå–å¾—
   */
  function getMethodName(method) {
    const names = {
      'calendar': 'ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼',
      'gmail': 'Gmail',
      'voice': 'éŸ³å£°å…¥åŠ›'
    };
    return names[method] || method;
  }
  
  /**
   * æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
   */
  function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleDateString('ja-JP');
  }
  
  /**
   * è¨­å®šç”»é¢è¡¨ç¤º
   */
  function showSettings() {
    document.getElementById('settings-modal').style.display = 'block';
    loadSettings();
  }
  
  /**
   * è¨­å®šç”»é¢ã‚’é–‰ã˜ã‚‹
   */
  function closeSettings() {
    document.getElementById('settings-modal').style.display = 'none';
  }
  
  /**
   * è¨­å®šèª­ã¿è¾¼ã¿
   */
  function loadSettings() {
    google.script.run
      .withSuccessHandler(function(config) {
        document.getElementById('notion-token').value = config.notionToken || '';
        document.getElementById('notion-database-id').value = config.notionDatabaseId || '';
        document.getElementById('claude-api-key').value = config.claudeApiKey || '';
        document.getElementById('gemini-api-key').value = config.geminiApiKey || '';
        document.getElementById('execution-frequency').value = config.executionFrequency || 'daily';
        document.getElementById('execution-hour').value = config.executionHour || 8;
        document.getElementById('data-range-days').value = config.dataRangeDays || 7;
        document.getElementById('enable-ai-analysis').checked = config.enableAiAnalysis || false;
        document.getElementById('enable-voice-input').checked = config.enableVoiceInput || false;
        document.getElementById('enable-gmail-analysis').checked = config.enableGmailAnalysis || false;
      })
      .withFailureHandler(function(error) {
        console.error('è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        alert('è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
      })
      .getConfig();
  }
  
  /**
   * è¨­å®šä¿å­˜
   */
  function saveSettings(event) {
    event.preventDefault();
    
    // ä¿å­˜ä¸­ã®è¡¨ç¤º
    const saveBtn = event.target.querySelector('.save-btn');
    const originalText = saveBtn.textContent;
    saveBtn.textContent = 'ä¿å­˜ä¸­...';
    saveBtn.disabled = true;
    
    const config = {
      notionToken: document.getElementById('notion-token').value.trim(),
      notionDatabaseId: document.getElementById('notion-database-id').value.trim(),
      claudeApiKey: document.getElementById('claude-api-key').value.trim(),
      geminiApiKey: document.getElementById('gemini-api-key').value.trim(),
      executionFrequency: document.getElementById('execution-frequency').value,
      executionHour: parseInt(document.getElementById('execution-hour').value),
      dataRangeDays: parseInt(document.getElementById('data-range-days').value),
      enableAiAnalysis: document.getElementById('enable-ai-analysis').checked,
      enableVoiceInput: document.getElementById('enable-voice-input').checked,
      enableGmailAnalysis: document.getElementById('enable-gmail-analysis').checked
    };
    
    console.log('ä¿å­˜ã™ã‚‹è¨­å®š:', config);
    
    google.script.run
      .withSuccessHandler(function(result) {
        console.log('è¨­å®šä¿å­˜æˆåŠŸ:', result);
        
        // è¨­å®šã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ã‚‚ä¿å­˜
        google.script.run
          .withSuccessHandler(function() {
            console.log('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä¿å­˜å®Œäº†');
            
            // PropertiesServiceã«åŒæœŸ
            google.script.run
              .withSuccessHandler(function() {
                console.log('è¨­å®šåŒæœŸå®Œäº†');
                alert('âœ… è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ\nå®Ÿè¡Œæ™‚é–“: ' + config.executionHour + 'æ™‚\nå®Ÿè¡Œé »åº¦: ' + config.executionFrequency);
                
                // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
                
                closeSettings();
              })
              .withFailureHandler(function(error) {
                console.error('è¨­å®šåŒæœŸã‚¨ãƒ©ãƒ¼:', error);
                alert('âš ï¸ è¨­å®šã¯ä¿å­˜ã•ã‚Œã¾ã—ãŸãŒã€åŒæœŸã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
              })
              .syncSheetToProperties();
          })
          .withFailureHandler(function(error) {
            console.error('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
            alert('âš ï¸ åŸºæœ¬è¨­å®šã¯ä¿å­˜ã•ã‚Œã¾ã—ãŸãŒã€ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä¿å­˜ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            
            saveBtn.textContent = originalText;
            saveBtn.disabled = false;
          })
          .saveConfigToSheet(config);
      })
      .withFailureHandler(function(error) {
        console.error('è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        alert('âŒ è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        
        saveBtn.textContent = originalText;
        saveBtn.disabled = false;
      })
      .setConfig(config);
  }
  
  /**
   * æ¥ç¶šãƒ†ã‚¹ãƒˆ
   */
  function testSettings() {
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.isValid) {
          alert('âœ… æ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸï¼è¨­å®šã¯æ­£å¸¸ã§ã™ã€‚');
        } else {
          alert('âŒ æ¥ç¶šãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ:\n' + result.errors.join('\n'));
        }
      })
      .withFailureHandler(function(error) {
        console.error('æ¥ç¶šãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
        alert('æ¥ç¶šãƒ†ã‚¹ãƒˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
      })
      .validateConfig();
  }
  
  // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
  document.addEventListener('DOMContentLoaded', function() {
    // éŒ²éŸ³ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById('start-recording').addEventListener('click', startRecording);
    document.getElementById('stop-recording').addEventListener('click', stopRecording);
    document.getElementById('process-voice').addEventListener('click', processVoiceInput);
    
    // è¨­å®šãƒ•ã‚©ãƒ¼ãƒ ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById('settings-form').addEventListener('submit', saveSettings);
    document.getElementById('email-filter-form').addEventListener('submit', saveEmailFilterSettings);
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    window.addEventListener('click', function(event) {
      const settingsModal = document.getElementById('settings-modal');
      const filterModal = document.getElementById('email-filter-modal');
      
      if (event.target === settingsModal) {
        closeSettings();
      }
      if (event.target === filterModal) {
        closeEmailFilterSettings();
      }
    });
  });
  
  /**
   * ãƒ¡ãƒ¼ãƒ«ãƒ•ã‚£ãƒ«ã‚¿è¨­å®šç”»é¢è¡¨ç¤º
   */
  function showEmailFilterSettings() {
    document.getElementById('email-filter-modal').style.display = 'block';
    loadCurrentFilterSettings();
  }
  
  /**
   * ãƒ¡ãƒ¼ãƒ«ãƒ•ã‚£ãƒ«ã‚¿è¨­å®šç”»é¢ã‚’é–‰ã˜ã‚‹
   */
  function closeEmailFilterSettings() {
    document.getElementById('email-filter-modal').style.display = 'none';
  }
  
  /**
   * ãƒ•ã‚£ãƒ«ã‚¿è¨­å®šã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
   */
  function showFilterTab(tabName) {
    // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    document.querySelector(`[onclick="showFilterTab('${tabName}')"]`).classList.add('active');
    
    // ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
    document.querySelectorAll('.tab-content').forEach(content => {
      content.classList.remove('active');
    });
    document.getElementById(`${tabName}-tab`).classList.add('active');
  }
  
  /**
   * ç¾åœ¨ã®ãƒ•ã‚£ãƒ«ã‚¿è¨­å®šã‚’èª­ã¿è¾¼ã¿
   */
  function loadCurrentFilterSettings() {
    google.script.run
      .withSuccessHandler(function(config) {
        // åŸºæœ¬è¨­å®š
        document.getElementById('gmail-search-query').value = config.gmailSearchQuery || 'in:inbox -is:archived';
        document.getElementById('gmail-max-results').value = config.gmailMaxResults || 50;
        document.getElementById('gmail-date-range-days').value = config.gmailDateRangeDays || 7;
        document.getElementById('gmail-min-subject-length').value = config.gmailMinSubjectLength || 3;
        document.getElementById('gmail-auto-exclude-categories').checked = config.gmailAutoExcludeCategories !== false;
        
        // é™¤å¤–è¨­å®š
        document.getElementById('gmail-exclude-senders').value = config.gmailExcludeSenders || '';
        document.getElementById('gmail-exclude-domains').value = config.gmailExcludeDomains || '';
        document.getElementById('gmail-exclude-labels').value = config.gmailExcludeLabels || '';
        document.getElementById('gmail-exclude-keywords').value = config.gmailExcludeKeywords || '';
        document.getElementById('gmail-enable-spam-filter').checked = config.gmailEnableSpamFilter === true;
        
        // å«ã‚ã‚‹è¨­å®š
        document.getElementById('gmail-include-senders').value = config.gmailIncludeSenders || '';
        document.getElementById('gmail-include-keywords').value = config.gmailIncludeKeywords || '';
        document.getElementById('gmail-high-priority-keywords').value = config.gmailHighPriorityKeywords || '';
        document.getElementById('gmail-enable-gemini-analysis').checked = config.gmailEnableGeminiAnalysis !== false;
      })
      .withFailureHandler(function(error) {
        console.error('ãƒ•ã‚£ãƒ«ã‚¿è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒ•ã‚£ãƒ«ã‚¿è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
      })
      .getConfig();
  }
  
  /**
   * ãƒ•ã‚£ãƒ«ã‚¿è¨­å®šä¿å­˜
   */
  function saveEmailFilterSettings(event) {
    event.preventDefault();
    
    const filterConfig = {
      GMAIL_SEARCH_QUERY: document.getElementById('gmail-search-query').value,
      GMAIL_MAX_RESULTS: document.getElementById('gmail-max-results').value,
      GMAIL_DATE_RANGE_DAYS: document.getElementById('gmail-date-range-days').value,
      GMAIL_MIN_SUBJECT_LENGTH: document.getElementById('gmail-min-subject-length').value,
      GMAIL_AUTO_EXCLUDE_CATEGORIES: document.getElementById('gmail-auto-exclude-categories').checked.toString(),
      GMAIL_EXCLUDE_SENDERS: document.getElementById('gmail-exclude-senders').value,
      GMAIL_EXCLUDE_DOMAINS: document.getElementById('gmail-exclude-domains').value,
      GMAIL_EXCLUDE_LABELS: document.getElementById('gmail-exclude-labels').value,
      GMAIL_EXCLUDE_KEYWORDS: document.getElementById('gmail-exclude-keywords').value,
      GMAIL_ENABLE_SPAM_FILTER: document.getElementById('gmail-enable-spam-filter').checked.toString(),
      GMAIL_INCLUDE_SENDERS: document.getElementById('gmail-include-senders').value,
      GMAIL_INCLUDE_KEYWORDS: document.getElementById('gmail-include-keywords').value,
      GMAIL_HIGH_PRIORITY_KEYWORDS: document.getElementById('gmail-high-priority-keywords').value,
      GMAIL_ENABLE_GEMINI_ANALYSIS: document.getElementById('gmail-enable-gemini-analysis').checked.toString()
    };
    
    google.script.run
      .withSuccessHandler(function() {
        alert('âœ… ãƒ¡ãƒ¼ãƒ«ãƒ•ã‚£ãƒ«ã‚¿è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        // è¨­å®šã‚’PropertiesServiceã«åŒæœŸ
        google.script.run.syncSheetToProperties();
      })
      .withFailureHandler(function(error) {
        console.error('ãƒ•ã‚£ãƒ«ã‚¿è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        alert('âŒ ãƒ•ã‚£ãƒ«ã‚¿è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      })
      .saveConfigToSheet(filterConfig);
  }
  
  /**
   * ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé©ç”¨
   */
  function applyTemplate(templateType) {
    if (!confirm(`${templateType}ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é©ç”¨ã—ã¾ã™ã‹ï¼Ÿç¾åœ¨ã®è¨­å®šã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚`)) {
      return;
    }
    
    google.script.run
      .withSuccessHandler(function() {
        alert(`âœ… ${templateType}ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é©ç”¨ã—ã¾ã—ãŸ`);
        loadCurrentFilterSettings(); // è¨­å®šã‚’å†èª­ã¿è¾¼ã¿
      })
      .withFailureHandler(function(error) {
        console.error('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé©ç”¨ã‚¨ãƒ©ãƒ¼:', error);
        alert('âŒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®é©ç”¨ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      })
      .applyEmailFilterTemplate(templateType);
  }
  
  /**
   * ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã«æˆ»ã™
   */
  function resetToDefaults() {
    if (!confirm('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã«æˆ»ã—ã¾ã™ã‹ï¼Ÿç¾åœ¨ã®è¨­å®šã¯å¤±ã‚ã‚Œã¾ã™ã€‚')) {
      return;
    }
    
    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
    document.getElementById('gmail-search-query').value = 'in:inbox -is:archived';
    document.getElementById('gmail-max-results').value = '50';
    document.getElementById('gmail-date-range-days').value = '7';
    document.getElementById('gmail-min-subject-length').value = '3';
    document.getElementById('gmail-auto-exclude-categories').checked = true;
    
    document.getElementById('gmail-exclude-senders').value = 'noreply@,newsletter@,marketing@';
    document.getElementById('gmail-exclude-domains').value = 'mailchimp.com,constantcontact.com';
    document.getElementById('gmail-exclude-labels').value = 'ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ¬ã‚¿ãƒ¼,å®£ä¼';
    document.getElementById('gmail-exclude-keywords').value = 'é…ä¿¡åœæ­¢,unsubscribe,åºƒå‘Š,ã‚»ãƒ¼ãƒ«,ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³';
    document.getElementById('gmail-enable-spam-filter').checked = true;
    
    document.getElementById('gmail-include-senders').value = '';
    document.getElementById('gmail-include-keywords').value = 'ä¼šè­°,æ‰“ã¡åˆã‚ã›,ç¢ºèª,ä¾é ¼,ç· åˆ‡,æå‡º,ä½œæˆ';
    document.getElementById('gmail-high-priority-keywords').value = 'ç·Šæ€¥,è‡³æ€¥,é‡è¦,ASAP,ç· åˆ‡';
    document.getElementById('gmail-enable-gemini-analysis').checked = true;
    
    alert('âœ… ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã«æˆ»ã—ã¾ã—ãŸ');
  }
  
  /**
   * ç¾åœ¨ã®è¨­å®šã§ãƒ†ã‚¹ãƒˆ
   */
  function testCurrentSettings() {
    google.script.run
      .withSuccessHandler(function(result) {
        let message = 'ğŸ” ãƒ¡ãƒ¼ãƒ«ãƒ•ã‚£ãƒ«ã‚¿ãƒ†ã‚¹ãƒˆçµæœ:\n\n';
        message += `ğŸ“§ ç·ãƒ¡ãƒ¼ãƒ«æ•°: ${result.total}\n`;
        message += `âœ… å‡¦ç†å¯¾è±¡: ${result.processed}\n`;
        message += `âŒ ã‚¹ã‚­ãƒƒãƒ—: ${result.skipped}\n`;
        message += `ğŸ”¥ é«˜å„ªå…ˆåº¦: ${result.highPriority}\n`;
        message += `ğŸ“‹ ä¸­å„ªå…ˆåº¦: ${result.mediumPriority}\n`;
        message += `ğŸ“ ä½å„ªå…ˆåº¦: ${result.lowPriority}\n`;
        
        if (result.reasons) {
          message += '\nğŸ“Š é™¤å¤–ç†ç”±:\n';
          Object.keys(result.reasons).forEach(reason => {
            message += `- ${reason}: ${result.reasons[reason]}ä»¶\n`;
          });
        }
        
        alert(message);
      })
      .withFailureHandler(function(error) {
        console.error('è¨­å®šãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
        alert('âŒ è¨­å®šãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      })
      .testRealEmailFiltering();
  }
  
  // GASé–¢æ•°ã®ãƒ—ãƒ­ã‚­ã‚·
  function getConfig() {
    return ConfigManager.getConfig();
  }
  
  function setConfig(config) {
    return ConfigManager.setConfig(config);
  }
  
  function validateConfig() {
    return ConfigManager.validateConfig();
  }
  
  function saveConfigToSheet(config) {
    return ConfigManager.saveConfigToSheet(config);
  }
  
  function syncSheetToProperties() {
    return ConfigManager.syncSheetToProperties();
  }
  
  function applyEmailFilterTemplate(templateType) {
    return applyEmailFilterTemplate(templateType);
  }
  
  function testRealEmailFiltering() {
    return testRealEmailFiltering();
  }
  
  /**
   * è‡ªå‹•å®Ÿè¡Œãƒˆãƒªã‚¬ãƒ¼ã‚’è¨­å®š
   */
  function setupTriggers() {
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          alert('âœ… è‡ªå‹•å®Ÿè¡Œãƒˆãƒªã‚¬ãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸ\n' + result.message);
        } else {
          alert('âŒ ãƒˆãƒªã‚¬ãƒ¼è¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸ\n' + result.error);
        }
      })
      .withFailureHandler(function(error) {
        console.error('ãƒˆãƒªã‚¬ãƒ¼è¨­å®šã‚¨ãƒ©ãƒ¼:', error);
        alert('âŒ ãƒˆãƒªã‚¬ãƒ¼è¨­å®šã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
      })
      .setupAutoTriggers();
  }
  
  /**
   * ç¾åœ¨ã®ãƒˆãƒªã‚¬ãƒ¼çŠ¶æ³ã‚’ç¢ºèª
   */
  function checkTriggers() {
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          let message = 'ğŸ” ç¾åœ¨ã®ãƒˆãƒªã‚¬ãƒ¼çŠ¶æ³:\n\n';
          message += `è¨­å®šæ¸ˆã¿ãƒˆãƒªã‚¬ãƒ¼æ•°: ${result.count}å€‹\n\n`;
          
          if (result.triggers && result.triggers.length > 0) {
            message += 'ğŸ“‹ ãƒˆãƒªã‚¬ãƒ¼è©³ç´°:\n';
            result.triggers.forEach((trigger, index) => {
              message += `${index + 1}. ${trigger.function}\n`;
              message += `   ã‚¿ã‚¤ãƒ—: ${trigger.type}\n`;
              message += `   æœ‰åŠ¹: ${trigger.enabled ? 'ã¯ã„' : 'ã„ã„ãˆ'}\n\n`;
            });
          } else {
            message += 'âš ï¸ è‡ªå‹•å®Ÿè¡Œãƒˆãƒªã‚¬ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“\n';
            message += 'ã€Œè‡ªå‹•å®Ÿè¡Œã‚’è¨­å®šã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è¨­å®šã—ã¦ãã ã•ã„';
          }
          
          alert(message);
        } else {
          alert('âŒ ãƒˆãƒªã‚¬ãƒ¼çŠ¶æ³ã®ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ\n' + result.error);
        }
      })
      .withFailureHandler(function(error) {
        console.error('ãƒˆãƒªã‚¬ãƒ¼ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
        alert('âŒ ãƒˆãƒªã‚¬ãƒ¼ç¢ºèªã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
      })
      .getTriggerInfo();
  }
  
  function setupAutoTriggers() {
    return setupAutoTriggers();
  }
  
  function getTriggerInfo() {
    return getTriggerInfo();
  }
</script>